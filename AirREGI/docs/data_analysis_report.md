# コール件数データ分析レポート

## 1. データ概要

### 使用データファイル

| ファイル | 期間 | 行数 | 内容 |
|----------|------|------|------|
| regi_call_data_transform.csv | 2018-06-01 ～ 2020-03-31 | 670 | コール件数（目的変数） |
| calender_data.csv | 2018-06-01 ～ 2020-03-31 | 670 | カレンダー情報（曜日、祝日等） |
| regi_acc_get_data_transform.csv | 2018-05-01 ～ 2020-03-31 | 701 | アカウント取得数（正規化済み） |
| cm_data.csv | 2018-03-01 ～ 2020-03-31 | 762 | キャンペーンフラグ |
| gt_service_name.csv | 2018-03-04 ～ 2020-03-29 | 109 | Google Trends検索数（週次） |

### マージ後のデータ構造

**ファイル**: `merged_call_data.csv` / `merged_call_data_numeric.csv`
**期間**: 2018-06-01 ～ 2020-03-31（670日分）

| カラム名 | 型 | 説明 |
|----------|------|------|
| cdr_date | datetime | 日付 |
| call_num | int | コール件数（目的変数） |
| dow | int | 曜日番号（1=月, 2=火, ..., 7=日） |
| dow_name | str | 曜日名（月, 火, ...） |
| woy | int | 年の週番号 |
| wom | int | 月の週番号 |
| doy | int | 年の日番号 |
| financial_year | int | 財政年度 |
| day_before_holiday_flag | bool | 休日前日フラグ |
| holiday_flag | bool | 休日フラグ |
| acc_get_cnt | float | アカウント取得数（正規化済み） |
| cm_flg | int | キャンペーンフラグ（0/1） |
| search_cnt | int | Google Trends検索数 |

## 2. 欠損値

**数値データに欠損はなし**

すべてのカラムで欠損値は0件でした。

## 3. コール件数の基本統計

| 統計量 | 値 |
|--------|-----|
| 平均 | 116.5件 |
| 中央値 | 121件 |
| 標準偏差 | 119.9件 |
| 最小値 | 0件 |
| 最大値 | 757件 |
| 25%点 | 0件 |
| 75%点 | 161件 |

## 4. 発見した知見

### 4.1 土日・祝日はコール件数が0

コール件数が0となる日のほとんどが土曜日、日曜日、または祝日です。
これはコールセンターが休業していることを示唆しています。

- **土曜日（dow=6）**: 基本的に0件
- **日曜日（dow=7）**: 基本的に0件
- **祝日（holiday_flag=TRUE）**: 基本的に0件

### 4.2 曜日による傾向

平日のコール件数には以下の傾向が見られます：

- **月曜日**: 週明けでやや多い傾向
- **金曜日**: 休前日で減少傾向
- 火〜木は比較的安定

### 4.3 季節性・イベント性

- **2019年9月下旬にピーク（757件）**: 消費税増税（2019年10月）前のキャンペーン期間と一致
- **年末年始**: コール件数が大幅に減少（休業期間）
- **GW期間**: 同様に減少

### 4.4 キャンペーンとの関連

`cm_flg=1`の期間（キャンペーン実施中）は、コール件数が増加する傾向があります。
特に2019年8月〜10月のキャンペーン期間は顕著な増加が見られます。

### 4.5 Google Trendsとの関連

検索数（`search_cnt`）が高い週はコール件数も増加する傾向があります。
ただし、週次データを日次に展開しているため、同一週内は同じ値が設定されています。

### 4.6 アカウント取得数との関連

`acc_get_cnt`は正規化された値（平均0、標準偏差1に近い）です。
この値が高い日はコール件数も増加する傾向があり、新規登録ユーザーからの問い合わせが多いことを示唆しています。

## 5. モデル構築に向けた推奨事項

### 特徴量候補

1. **時系列特徴量**
   - 曜日（dow）: 土日は明確にパターンが異なる
   - 祝日フラグ（holiday_flag）
   - 休前日フラグ（day_before_holiday_flag）
   - 月（cdr_dateから抽出可能）

2. **外部要因**
   - キャンペーンフラグ（cm_flg）: 影響大
   - Google Trends検索数（search_cnt）
   - アカウント取得数（acc_get_cnt）

3. **ラグ特徴量**
   - 前日・前週同曜日のコール件数
   - 移動平均

### 注意点

- 土日・祝日は予測対象外とするか、別モデルとして扱うことを検討
- 2019年9月〜10月の消費税増税イベントは外れ値として扱うか検討
- COVID-19の影響（2020年3月〜）が含まれる可能性

## 6. データクリーニング

### 6.1 休業日フラグの問題

元データの`holiday_flag`（カレンダー上の祝日）と実際の休業日に不整合がありました。

| 項目 | 日数 |
|------|------|
| 元のholiday_flag=1 | 220日 |
| 実際の休業日（call_num=0） | 243日 |
| 祝日だが営業 | 4日（2019年GW中） |
| 平日だが休業 | 27日 |

### 6.2 平日休業日の内訳

以下の期間で、平日にもかかわらずcall_num=0でした：

- **2019年1月9日〜31日**: 約3週間の連続休業（システム移行等の可能性）
- **2019年11月18日〜22日**: 5日間連続休業
- **年末年始**: 12/31, 1/2など
- **単発**: 2018/8/31, 2018/9/6, 2019/10/15

### 6.3 クリーニング処理

`call_num=0`の日を実際の休業日（`closed_flag=1`）として定義し、営業日のみを予測対象としました。

| データセット | 日数 |
|-------------|------|
| 全データ | 670日 |
| 営業日（closed_flag=0） | **427日** |
| 休業日（closed_flag=1） | 243日 |

### 6.4 営業日の統計（クリーニング後）

| 統計量 | 値 |
|--------|-----|
| 平均 | 182.8件 |
| 中央値 | 150件 |
| 標準偏差 | 102.2件 |
| 最小値 | 18件 |
| 最大値 | 757件 |

### 6.5 外れ値

平均±3σの範囲外となる外れ値が10日ありました（閾値: 489件以上）。
すべて2019年9月〜10月の消費税増税前のピーク期間です。

| 日付 | コール件数 |
|------|-----------|
| 2019-09-25 | 757件 |
| 2019-09-24 | 681件 |
| 2019-09-26 | 636件 |
| 2019-09-27 | 618件 |
| 2018-10-25 | 595件 |

## 7. 予測システム検証

### 7.1 予測シナリオ

| シナリオ | 予測実行日 | 予測対象 | ホライズン |
|----------|-----------|----------|-----------|
| 週次予測 | 毎週水曜 | 翌週月〜金 | 5〜9営業日先 |
| 月次予測 | 毎月20日 | 翌月1ヶ月 | 約10〜40日先 |

### 7.2 使用モデル

```
GradientBoostingRegressor(n_estimators=100, max_depth=5)
```

### 7.3 特徴量（リークなし設計）

| カテゴリ | 特徴量 | 使用可否 |
|----------|--------|----------|
| カレンダー | dow, month, day, week_of_year | ○ 予測対象日の情報 |
| 計画情報 | cm_flg | ○ 事前に計画あり |
| コール実績 | call_lag_5〜9, call_ma_5/10/20 | ○ 予測実行日までの実績 |
| 外部実績 | acc_lag, acc_ma_5/10, search_lag | ○ 予測実行日までの実績 |
| 外部（当日） | acc_get_cnt, search_cnt の当日値 | × 予測時点で未知 |

### 7.4 検証結果（バックテスト）

| 予測タイプ | MAE | 誤差率 | 評価 |
|-----------|-----|--------|------|
| 週次予測 | 47.7件 | 35.0% | ○ 実用可能 |
| 月次予測 | 45.8件 | 29.4% | ○ 実用可能 |

### 7.5 特徴量重要度

| 順位 | 特徴量 | 重要度 | 説明 |
|------|--------|--------|------|
| 1 | call_lag_5 | 0.513 | 5営業日前のコール件数 |
| 2 | acc_lag | 0.162 | アカウント取得数ラグ |
| 3 | call_ma_20 | 0.051 | 20日移動平均 |
| 4 | acc_ma_10 | 0.047 | アカウント取得数MA |
| 5 | call_lag_6 | 0.038 | 6営業日前のコール件数 |

**知見**: 直近のコール件数実績とアカウント取得数が予測に最も有効。

## 8. ディレクトリ構造

```
AirREGI/
├── data/
│   ├── raw/                          # 元データ
│   │   ├── regi_call_data_transform.csv
│   │   ├── regi_acc_get_data_transform.csv
│   │   ├── calender_data.csv
│   │   ├── cm_data.csv
│   │   └── gt_service_name.csv
│   └── processed/                    # 処理済みデータ
│       ├── merged_call_data_numeric.csv
│       ├── cleaned_data.csv
│       └── business_days_data.csv
├── src/                              # ソースコード
│   ├── prepare_data.py               # データ準備スクリプト
│   ├── data_cleaning.py              # データクリーニングモジュール
│   └── forecast_with_cleaned_data.py # 予測検証スクリプト
├── results/                          # 実験結果
│   ├── weekly_backtest_cleaned.csv
│   ├── monthly_backtest_cleaned.csv
│   ├── weekly_predictions_cleaned.csv
│   └── monthly_predictions_cleaned.csv
└── docs/                             # ドキュメント
    └── data_analysis_report.md
```
